# ============================================
# DOCKERFILE BACKEND - Node.js + Express
# ============================================
# Ce Dockerfile cr√©e une image Docker pour le backend
# Il installe les d√©pendances et d√©marre le serveur Express

# Utiliser une image Node.js officielle bas√©e sur Debian (pour better-sqlite3)
FROM node:20-slim

# Installer les outils n√©cessaires pour compiler better-sqlite3 (module natif)
# python3, make, g++ sont requis pour compiler les modules Node.js natifs
# curl est n√©cessaire pour le healthcheck Docker
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/*

# D√©finir le r√©pertoire de travail dans le conteneur
WORKDIR /app

# Copier les fichiers package.json pour installer les d√©pendances
# On copie d'abord les d√©pendances pour b√©n√©ficier du cache Docker
COPY backend/package*.json ./

# Installer les d√©pendances
# Utiliser npm install au lieu de npm ci pour plus de flexibilit√©
# --only=production installe uniquement les d√©pendances de production (pas les devDependencies)
RUN npm install --only=production --verbose

# Copier tout le code du backend
COPY backend/ ./

# Copier le fichier database.sqlite3 initial (sera utilis√© par le script d'init)
# Le fichier sera copi√© dans le volume Docker au d√©marrage si n√©cessaire
# Note: Si le fichier n'existe pas, le build continuera et le script d'init g√©rera le cas
RUN cp database.sqlite3 database.sqlite3.initial 2>/dev/null || echo "‚ö†Ô∏è database.sqlite3 non trouv√©"

# Cr√©er le dossier modeles.initial et copier les mod√®les depuis le code copi√©
# Les mod√®les sont d√©j√† dans ./modeles/ gr√¢ce au COPY backend/ ci-dessus
RUN mkdir -p ./modeles.initial && \
    echo "üîç V√©rification du dossier modeles..." && \
    if [ -d "./modeles" ]; then \
        echo "   Dossier modeles existe" && \
        echo "   Contenu:" && \
        ls -la ./modeles/ || echo "   (vide)" && \
        if [ "$(ls -A ./modeles 2>/dev/null)" ]; then \
            echo "   Copie des mod√®les..." && \
            cp -r ./modeles/* ./modeles.initial/ && \
            echo "‚úÖ Mod√®les copi√©s dans modeles.initial" && \
            echo "   V√©rification:" && \
            ls -la ./modeles.initial/ || echo "   (erreur)"; \
        else \
            echo "‚ö†Ô∏è Dossier modeles est vide"; \
        fi; \
    else \
        echo "‚ö†Ô∏è Dossier modeles n'existe pas"; \
    fi

# Cr√©er les dossiers n√©cessaires
RUN mkdir -p output && mkdir -p data && mkdir -p modeles

# Rendre le script d'initialisation ex√©cutable
RUN chmod +x init-db.sh || true

# Exposer le port sur lequel le serveur √©coute
EXPOSE 3000

# Variable d'environnement pour Node.js (production)
ENV NODE_ENV=production

# Script d'entrypoint qui initialise la BDD puis d√©marre le serveur
COPY backend/init-db.sh ./init-db.sh
RUN chmod +x init-db.sh

# Commande pour d√©marrer le serveur
# Le script d'init copie database.sqlite3 dans le volume si n√©cessaire
CMD ["sh", "-c", "./init-db.sh && node server.js"]