# ============================================
# DOCKER COMPOSE - Configuration du déploiement
# ============================================
# Ce fichier orchestre le déploiement de l'application complète
# Il définit les services (frontend, backend) et leur configuration

version: "3.8"

services:
  # ============================================
  # SERVICE BACKEND
  # ============================================
  backend:
    # Script d'initialisation (créer les fichiers nécessaires avant le montage)
    # Note: Ce script doit être exécuté manuellement avant le premier déploiement
    # ou via un script de déploiement
    # Nom du service (utilisé pour la communication entre conteneurs)
    container_name: http-tools-backend

    # Utiliser le Dockerfile du backend
    build:
      context: .
      dockerfile: Dockerfile.backend

    # Ports exposés : port_hôte:port_conteneur
    # Le backend sera accessible sur http://localhost:3000 depuis la machine hôte
    ports:
      - "3000:3000"

    # Variables d'environnement (optionnel, peut être surchargé par .env)
    environment:
      - NODE_ENV=production
      - PORT=3000
      # Chemin de la base de données dans le volume monté
      - DB_PATH=/app/data/database.sqlite3

    # Volumes : utiliser un volume nommé pour la BDD (plus robuste)
    # Les volumes nommés sont créés automatiquement par Docker
    volumes:
      # Base de données SQLite (volume nommé - créé automatiquement)
      # Le fichier sera créé par l'application dans ce volume
      - http-tools-db:/app/data
      # Modèles Draw.io (volume nommé pour permettre les mises à jour via l'interface web)
      # Les modèles initiaux sont copiés depuis l'image au démarrage
      - http-tools-modeles:/app/modeles
      # Dossier de sortie (pour les fichiers générés)
      - ./backend/output:/app/output

    # Réseau : tous les services partagent le même réseau
    networks:
      - http-tools-network

    # Redémarrer automatiquement en cas de crash
    restart: unless-stopped

    # Healthcheck : vérifier que le backend répond
    # Utilise la route racine qui est plus simple et ne nécessite pas la BDD
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # SERVICE FRONTEND
  # ============================================
  frontend:
    # Nom du service
    container_name: http-tools-frontend

    # Utiliser le Dockerfile du frontend
    build:
      context: .
      dockerfile: Dockerfile.frontend

    # Ports exposés : le frontend sera accessible sur http://localhost:8888
    ports:
      - "8888:80"

    # Dépend du backend (attendre que le backend soit prêt)
    depends_on:
      backend:
        condition: service_healthy

    # Réseau partagé avec le backend
    networks:
      - http-tools-network

    # Redémarrer automatiquement
    restart: unless-stopped

# ============================================
# RÉSEAUX
# ============================================
# Définit un réseau Docker pour que les services communiquent entre eux
networks:
  http-tools-network:
    driver: bridge

# ============================================
# VOLUMES NOMÉS
# ============================================
# Volumes Docker pour la persistance des données
# Ces volumes sont créés automatiquement par Docker
volumes:
  # Volume pour la base de données SQLite
  http-tools-db:
    driver: local
  # Volume pour les modèles Draw.io
  http-tools-modeles:
    driver: local
